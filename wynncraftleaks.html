<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Test</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            .block {
                background-color: gray;
            }
            .water {
                background: blue;
                z-index: 10000;
                display: flex;
            }
            .gate-dir {
                z-index: 2;
                background-color:rgb(85, 42, 11);
                margin: auto;
            }
            .gate-y {
                height: 50px;
                width: 20px;
            }
            .gate-x {
                height: 20px;
                width: 50px;
            }
            .piece {
                display:inline-flex;
                width: 50px;
                height: 50px;
                position: relative;
            }
            .active:hover {
                cursor:pointer;
            }
            .open::after {
                content: "";
                width: 25px;
                background-color: white;
                position: absolute;
                height: 25px;
                left:25%;
                top: 25%;
                z-index: 200;
            }

            .air {
                background-color: white;
            }
            .row {
                display: flex;
                margin: 0;
                padding: 0;
            }

            .start-water {
                margin: 20px;
                padding: 10px;
            }
            .number {
                margin: auto;
                font-size: 20px;
                color: white;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <button class="start-water">Start Water</button>

        <script async defer>
            function getFromCords(x, y) {
                return document.querySelector(`div[data-x="${x}"][data-y="${y}"]`);
            }

            class Block {
                constructor(x, y, disabled) {
                    this.x = x;
                    this.y = y;
                    this.disabled = disabled;
                }
            }

            class Gate {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.open = false;
                }
            }

            class Air {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                }
            }
            
            let data = [];

            for (let i = 0; i < 9; i++) {
                let newArr = [];

                if (!(i % 2)) {
                    for (let j = 0; j < 9; j++) {
                        if (i === 0 || i === 8) {
                            if (i === 8 && j === 1) {
                                newArr.push(new Air(j, i));
                            } else {
                                newArr.push(new Block(j, i, true));
                            }
                        } else {
                            if (!(j % 2)) {
                                if (j === 0 || j === 8) {
                                    newArr.push(new Block(j, i, true));
                                } else {
                                    newArr.push(new Block(j, i, false));
                                }
                            } else {
                                newArr.push(new Gate(j, i));
                            }
                        }
                    }
                } else {
                    for (let j = 0; j < 9; j++) {
                        if (j === 0 || j === 8) {
                            if (i === 1 && j === 8) {
                                newArr.push(new Air(j, i));
                            } else {
                                newArr.push(new Block(j, i, true));
                            }
                        } else {
                            if (!(j % 2)) {
                                newArr.push(new Gate(j, i));
                            } else {
                                newArr.push(new Air(j, i));
                            }
                        }
                    }
                }
                data.push(newArr);
            }

            let parent = document.createElement("div");

            for (i of data) {
                let row = document.createElement("div");
                row.setAttribute("class", "row");
                for (j of i) {
                    let piece = document.createElement("div");
                    piece.setAttribute("class", "piece");
                    piece.setAttribute("data-x", j.x);
                    piece.setAttribute("data-y", j.y);
                    if (j instanceof Block) {
                        piece.setAttribute("class", "piece block");
                        if (!j.disabled) {
                            piece.setAttribute("class", "piece block active");
                        }
                    } else if (j instanceof Gate) {
                        piece.setAttribute("class", "piece gate");
                        let gateDirection = document.createElement("div");
                        if (i.indexOf(j) % 2) {
                            gateDirection.setAttribute("class", "gate-dir gate-x");
                        } else {
                            gateDirection.setAttribute("class", "gate-dir gate-y");
                        }
                        piece.appendChild(gateDirection);
                    } else if (j instanceof Air) {
                        piece.setAttribute("class", "piece air");
                    }
                    row.appendChild(piece);
                }
                parent.appendChild(row);
            }
            document.body.appendChild(parent);

            for (let i of document.querySelectorAll(".block.active")) {
                i.addEventListener("click", event => {
                    let element = event.srcElement;
                    let x = parseInt(element.getAttribute("data-x")), y = parseInt(element.getAttribute("data-y"));
                    let arrayOfAll = [data[y-1][x], data[y][x+1], data[y+1][x], data[y][x-1]];

                    for (let gate of arrayOfAll) {
                        let element = getFromCords(gate.x, gate.y);
                        if (element.getAttribute("class").includes("open")) {
                            element.setAttribute("class", element.getAttribute("class").replace(" open", "") + " closed");
                            gate.open = true;
                        } else {
                            element.setAttribute("class", element.getAttribute("class").replace(" closed", "") + " open");
                            gate.open = false;
                        }
                    }
                })
            }

            function sleep(time) {
                return new Promise((resolve, reject) => {
                    setTimeout(resolve, time);
                })
            }

            function makeNum(element, number) {
                let newNum = document.createElement("p");
                newNum.classList.add("number");
                newNum.innerText = number;
                element.appendChild(newNum);
            }

            document.querySelector(".start-water").addEventListener("click", async e => {
                let counter = 1;
                getFromCords(1, 8).setAttribute("class", "piece water new");
                makeNum(getFromCords(1, 8), counter);
                await sleep(1000);

                while (document.querySelectorAll(".water.new").length > 0) {
                    let success = false;
                    document.querySelectorAll(".water.new").forEach(element => {
                        try {
                            if ([...getFromCords(parseInt(element.getAttribute("data-x")) - 1, parseInt(element.getAttribute("data-y"))).classList].some(item => item === "open" || item === "air")) {
                                getFromCords(parseInt(element.getAttribute("data-x")) - 1, parseInt(element.getAttribute("data-y"))).className = "piece water super-new";
                                success = true;
                            }
                            if ([...getFromCords(parseInt(element.getAttribute("data-x")), parseInt(element.getAttribute("data-y")) - 1).classList].some(item => item === "open" || item === "air")) {
                                getFromCords(parseInt(element.getAttribute("data-x")), parseInt(element.getAttribute("data-y")) - 1).className = "piece water super-new";
                                success = true;
                            }
                            if ([...getFromCords(parseInt(element.getAttribute("data-x")) + 1, parseInt(element.getAttribute("data-y"))).classList].some(item => item === "open" || item === "air")) {
                                getFromCords(parseInt(element.getAttribute("data-x")) + 1, parseInt(element.getAttribute("data-y"))).className = "piece water super-new";
                                success = true;
                            }
                            if ([...getFromCords(parseInt(element.getAttribute("data-x")), parseInt(element.getAttribute("data-y")) + 1).classList].some(item => item === "open" || item === "air")) {
                                getFromCords(parseInt(element.getAttribute("data-x")), parseInt(element.getAttribute("data-y")) + 1).className = "piece water super-new";
                                success = true;
                            }

                        } catch(e) {
                            e;
                        }

                        element.classList.remove("new");
                    });

                    for (const element of document.querySelectorAll(".water.super-new")) {
                        element.classList.remove("super-new");
                        element.classList.add("new");
                        try {
                            element.removeChild(element.querySelector(".gate-dir"));
                        } catch(e) {
                            e;
                        }
                        counter += 1;
                        makeNum(element, counter);

                        if (counter === 25) {
                            break;
                        }
                    };      

                    await sleep(1000);

                    if (!success) {
                        alert("The water got trapped! Reload the page to try again.");
                        break;
                    }

                    if (counter === 25) {
                        alert("The water spread 25 blocks but didn't reach the end! Reload the page to try again.");
                        break;
                    }

                    if (getFromCords(8, 1).classList.contains("water")) {
                        alert("You got the water to the end in under 25 blocks! Well done! Reload the page to try again.");
                        break;
                    }
                }
            })
        </script>

        <div style="margin-left: 50px;">
                ^^^<br />
            water starts here
        </div>
    </body>
</html>
